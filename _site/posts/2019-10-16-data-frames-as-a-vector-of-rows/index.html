<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.344">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Davis Vaughan">
<meta name="dcterms.date" content="2019-10-16">
<title>Davis Vaughan - Data Frames as Vectors of Rows</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<script src="../../site_libs/quarto-nav/quarto-nav.js"></script><script src="../../site_libs/quarto-nav/headroom.min.js"></script><script src="../../site_libs/clipboard/clipboard.min.js"></script><meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script><script src="../../site_libs/quarto-search/fuse.min.js"></script><script src="../../site_libs/quarto-search/quarto-search.js"></script><script src="../../site_libs/quarto-html/quarto.js"></script><script src="../../site_libs/quarto-html/popper.min.js"></script><script src="../../site_libs/quarto-html/tippy.umd.min.js"></script><script src="../../site_libs/quarto-html/anchor.min.js"></script><link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script><link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Davis Vaughan</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html">Posts</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/DavisVaughan"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/dvaughan32"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
<div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Data Frames as Vectors of Rows</h1>
                </div>
  </div>
    
  



  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Davis Vaughan </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 16, 2019</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#c" id="toc-c" class="nav-link active" data-scroll-target="#c"><code>c()</code></a></li>
  <li><a href="#vec_size" id="toc-vec_size" class="nav-link" data-scroll-target="#vec_size"><code>vec_size()</code></a></li>
  <li><a href="#vec_c" id="toc-vec_c" class="nav-link" data-scroll-target="#vec_c"><code>vec_c()</code></a></li>
  <li><a href="#vec_match" id="toc-vec_match" class="nav-link" data-scroll-target="#vec_match"><code>vec_match()</code></a></li>
  <li><a href="#slide" id="toc-slide" class="nav-link" data-scroll-target="#slide"><code>slide()</code></a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li>
<a href="#extra---unique-and-split" id="toc-extra---unique-and-split" class="nav-link" data-scroll-target="#extra---unique-and-split">Extra - <code>unique()</code> and <code>split()</code></a>
  <ul class="collapse">
<li><a href="#unique" id="toc-unique" class="nav-link" data-scroll-target="#unique"><code>unique()</code></a></li>
  <li><a href="#split" id="toc-split" class="nav-link" data-scroll-target="#split"><code>split()</code></a></li>
  </ul>
</li>
  </ul></nav>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><p>Recently, I have been working a lot on <a href="https://github.com/r-lib/vctrs">{vctrs}</a>. This package is an attempt to analyze the atomic types in R, such as <code>integer</code>, <code>character</code> and <code>double</code>, alongside the recursive types of <code>list</code> and <code>data.frame</code>, to extract a set of common principles. From this analysis, a growing toolkit of functions for working with vector types has developed around two themes of <em>size</em> and <em>prototype</em>. vctrs is a <em>fun</em> package to work on, and even more fun to build on top of.</p>
<div class="page-columns page-full"><p>The goal of this post is two fold. First, I want to show off a few functions and packages that have been built using this new toolkit which contribute to why I think this package is so fun. Second, I’d like to introduce a shift in the way you might normally think about data frames, <em>from a vector of columns to a vector of rows</em>. </p><div class="no-row-height column-margin column-container"><span class="aside">Hadley is the one who recognized that viewing data frames from this angle opens up powerful new workflows that are especially useful for data analysis.</span></div></div>
<p>If you’ve never heard of vctrs before, there’s a reason for that. For the most part, it’s a developer focused package, and honestly if you never knew this package existed, but still used the higher level packages that were built on top of it, then we’ve done our job. A few examples of packages that rely heavily on vctrs right now are:</p>
<ul>
<li>
<a href="https://tidyr.tidyverse.org/articles/pivot.html">tidyr’s</a> <code>pivot_longer()</code> and <code>pivot_wider()</code>, along with a number of other existing functions that recently got rewritten using vctrs principles</li>
<li>
<a href="https://davisvaughan.github.io/slider/">slider</a>, for working with window functions (like moving averages)</li>
<li>
<a href="https://rray.r-lib.org/">rray</a>, an array manipulation library</li>
<li>
<a href="https://github.com/tidyverse/tibble">tibble’s</a> development version</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://vctrs.r-lib.org/">vctrs</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/">tibble</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="c" class="level2"><h2 class="anchored" data-anchor-id="c"><code>c()</code></h2>
<p>As you gain more experience working with R, you eventually start to learn about how certain data structures are implemented. A data frame, for example, is really a list where each element of the list is a single column. In other words, a data frame is a vector of columns.</p>
<p>One way to see this is by the fact that <code><a href="https://rdrr.io/r/base/length.html">length()</a></code> returns the number of columns.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, 
  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"a"</span><span class="op">)</span>, 
  z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"x"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">df</span>
<span class="co">#&gt; # A tibble: 4 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     1 a     x    </span>
<span class="co">#&gt; 2     2 b     x    </span>
<span class="co">#&gt; 3     3 a     y    </span>
<span class="co">#&gt; 4     4 a     x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>
<span class="co">#&gt; [1] 3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can also check that a data frame is a list by calling <code><a href="https://rdrr.io/r/base/list.html">is.list()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This underlying assumption that a data frame is a vector of columns is deeply rooted into a number of R’s core functions, and is often used as a fallback when behavior is otherwise ill-defined. Consider, as an example, calling <code>c(df, df)</code> to “combine” the data frame with itself.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df</span><span class="op">)</span>
<span class="co">#&gt; $x</span>
<span class="co">#&gt; [1] 1 2 3 4</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $y</span>
<span class="co">#&gt; [1] "a" "b" "a" "a"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $z</span>
<span class="co">#&gt; [1] "x" "x" "y" "x"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $x</span>
<span class="co">#&gt; [1] 1 2 3 4</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $y</span>
<span class="co">#&gt; [1] "a" "b" "a" "a"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $z</span>
<span class="co">#&gt; [1] "x" "x" "y" "x"</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our data frames have combined to become a list! In a way, this behavior is consistent with the principle that a data frame is a list of columns. It follows the invariant (read: “unbreakable principle”) of:</p>
<center>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</center>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>
<span class="co">#&gt; [1] 6</span>

<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Is there any other type of output that makes sense? If we think of a data frame as a vector of columns, then no, because it makes sense to end up with something of length 6 after combining. However, I’d argue that if we flip our understanding of data frames from a vector of columns to a vector of rows, then another solution comes forward which offers a different result that I have begun to find pretty attractive.</p>
</section><section id="vec_size" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="vec_size"><code>vec_size()</code></h2>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="aside">Much of this particular section is adapted from the vctrs <a href="https://vctrs.r-lib.org/articles/type-size.html#size">vignette</a> on size.</span></div></div>
<p>To start the process of thinking about a “vector of rows”, look again to <code>df</code>. A single “row” would be:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">df</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>
<span class="co">#&gt; # A tibble: 1 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     1 a     x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With that in mind, <code>df</code> would be considered a vector of 4 rows. It would be nice to have a function that returned this information as a building block to work off of (as shown before, <code><a href="https://rdrr.io/r/base/length.html">length()</a></code> won’t do). We could try and use <code><a href="https://rdrr.io/r/base/nrow.html">nrow()</a></code>, which gives us what we want, but it returns <code>NULL</code> when given an individual column.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>
<span class="co">#&gt; [1] 4</span>

<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
<span class="co">#&gt; NULL</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What I’m looking for is a function that returns a value that is equivalent for the data frame itself and for any column of the data frame. Put another way, I’m really after the “number of observations”. One other option is to use <code><a href="https://rdrr.io/r/base/nrow.html">NROW()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">NROW</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>
<span class="co">#&gt; [1] 4</span>

<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">NROW</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
<span class="co">#&gt; [1] 4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This looks good, but what happens if you give it some “non-vector” input? A practical way to think about that is something that isn’t allowed to exist as a column of a data frame, for example, a function, or an <code>lm</code> object.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>
<span class="co">#&gt; Error in as.data.frame.default(x[[i]], optional = TRUE): cannot coerce class '"function"' to a data.frame</span>

<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">NROW</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span>
<span class="co">#&gt; [1] 1</span>

<span class="va">lm_cars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">cyl</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lm_cars</span><span class="op">)</span>
<span class="co">#&gt; Error in as.data.frame.default(x[[i]], optional = TRUE, stringsAsFactors = stringsAsFactors): cannot coerce class '"lm"' to a data.frame</span>

<span class="co"># Treats it as a list</span>
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">NROW</a></span><span class="op">(</span><span class="va">lm_cars</span><span class="op">)</span>
<span class="co">#&gt; [1] 12</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These objects are considered <em>scalar</em> types rather than <em>vector</em> types. They are “scalar” in the sense that you only ever consider them one at a time. Even though <code>lm_cars</code> is <em>technically</em> implemented as a list, we look at it is as a single linear model object.</p>
<p>Compare that to a double <em>vector</em> like <code>c(1, 2, 3)</code> which is made up of 3 observations.</p>
<p>For our purposes, it’s valuable to keep scalar and vector types distinct, so it would be nice if an error was thrown for scalars to indicate that they don’t really have this “number of observations” property that we are after.</p>
<p>Motivated by this, the concept of <code>size</code> was created in vctrs to capture the invariants that were desired. In particular:</p>
<ul>
<li>It is the length of 1d vectors.</li>
<li>It is the number of rows of data frames, matrices, and arrays.</li>
<li>It throws error for non vectors.</li>
</ul>
<p>The vctrs function, <code><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size()</a></code>, is the resulting implementation of this concept.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>
<span class="co">#&gt; [1] 4</span>

<span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>
<span class="co">#&gt; [1] 4</span>

<span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span>
<span class="co">#&gt; Error in `vec_size()`:</span>
<span class="co">#&gt; ! `x` must be a vector, not a function.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="vec_c" class="level2"><h2 class="anchored" data-anchor-id="vec_c"><code>vec_c()</code></h2>
<p>Armed with the concept of size, let’s take another look at <code>c(df, df)</code>. If the length invariant for <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> looks like:</p>
<center>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</center>
<p>then imagine what would happen if <code><a href="https://rdrr.io/r/base/length.html">length()</a></code> was swapped with <code><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size()</a></code>:</p>
<center>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vec_size</span>(<span class="fu">c</span>(x, y)) <span class="ot">=</span>?<span class="ot">=</span> <span class="fu">vec_size</span>(x) <span class="sc">+</span> <span class="fu">vec_size</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</center>
<p>Does this invariant hold? For 1d vectors, it does because <code><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size()</a></code> and <code><a href="https://rdrr.io/r/base/length.html">length()</a></code> are essentially the same. But for data frames, we’ve seen that <code><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size()</a></code> and <code><a href="https://rdrr.io/r/base/length.html">length()</a></code> are different, and <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> was built with <code><a href="https://rdrr.io/r/base/length.html">length()</a></code> in mind, so it might not. In fact, looking at our original example of <code>c(df, df)</code> proves that it doesn’t hold:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>
<span class="co">#&gt; [1] 8</span>

<span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’d like this invariant to hold, but <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> isn’t the right tool for the job. Instead, an alternative, <code><a href="https://vctrs.r-lib.org/reference/vec_c.html">vec_c()</a></code>, was built that builds off of <code><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size()</a></code> and this invariant. The invariant that does hold actually looks like:</p>
<center>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size</a></span><span class="op">(</span><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</center>
<p>So what does <code><a href="https://vctrs.r-lib.org/reference/vec_c.html">vec_c()</a></code> do? For 1d vectors it acts like <code><a href="https://rdrr.io/r/base/c.html">c()</a></code>, as you might expect.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>
<span class="co">#&gt; [1] 1 2 3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But what about with <code>vec_c(df, df)</code>? Based on the fact that <code>vec_size(df) + vec_size(df) = 8</code>, at the very least we know it should return something with a size of 8. To accomplish this, rather than coercing to a list and combining the columns together, <code><a href="https://vctrs.r-lib.org/reference/vec_c.html">vec_c()</a></code> instead leaves them as data frames and <em>combines the rows</em>.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 8 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     1 a     x    </span>
<span class="co">#&gt; 2     2 b     x    </span>
<span class="co">#&gt; 3     3 a     y    </span>
<span class="co">#&gt; 4     4 a     x    </span>
<span class="co">#&gt; 5     1 a     x    </span>
<span class="co">#&gt; 6     2 b     x    </span>
<span class="co">#&gt; 7     3 a     y    </span>
<span class="co">#&gt; 8     4 a     x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you view a data frame as a vector of rows, this makes complete sense. We start with a vector of 4 rows, and add another vector of 4 rows, so we should end up with a vector of 8 rows, i.e.&nbsp;a data frame with size 8.</p>
<p>What happens if we combine <code>df</code> with a data frame containing one row but an entirely new column? Again, we “know” from our size invariant that we should get something back with a size of 5.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">df_w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>w <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>

<span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df_w</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 5 × 4</span>
<span class="co">#&gt;       x y     z         w</span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     1 a     x        NA</span>
<span class="co">#&gt; 2     2 b     x        NA</span>
<span class="co">#&gt; 3     3 a     y        NA</span>
<span class="co">#&gt; 4     4 a     x        NA</span>
<span class="co">#&gt; 5    NA &lt;NA&gt;  &lt;NA&gt;      1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result is a data frame with 5 rows, and a union of the columns coming from each of the two individual data frames. Without getting too much into it, the fact that the result is a “tibble with 4 columns: x (int), y (chr), z (chr), and w (dbl)” comes from the other half of what vctrs offers, the <em>prototype</em>. <code><a href="https://vctrs.r-lib.org/reference/vec_c.html">vec_c()</a></code> found the “common type” between <code>df</code> and <code>df_w</code>, which is the union holding those 4 columns.</p>
<p>What about combining <code>df</code> with something like the double vector, <code>c(1, 2)</code>? We’d expect a size of 6 (4 from <code>df</code> and 2 from the vector), but we actually get an error because the size is only half of the story.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Error:</span>
<span class="co">#&gt; ! Can't combine `..1` &lt;tbl_df&gt; and `..2` &lt;double&gt;.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case, there is no common type between a data frame and a double vector, so you can’t combine them together.</p>
<p>Compare that with the result from <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> which upholds its length invariant giving a result of length 5.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; $x</span>
<span class="co">#&gt; [1] 1 2 3 4</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $y</span>
<span class="co">#&gt; [1] "a" "b" "a" "a"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $z</span>
<span class="co">#&gt; [1] "x" "x" "y" "x"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; [1] 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[5]]</span>
<span class="co">#&gt; [1] 2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="vec_match" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="vec_match"><code>vec_match()</code></h2>
<p>Treatment of a data frame as a vector of rows extends well past <code><a href="https://vctrs.r-lib.org/reference/vec_c.html">vec_c()</a></code>, and bleeds into many other vctrs tools where we have been experimenting with this idea. As one more example, we’ll take a look at <code><a href="https://rdrr.io/r/base/match.html">match()</a></code>. If you aren’t familiar with <code><a href="https://rdrr.io/r/base/match.html">match()</a></code>, it tells you the location of <code>x</code> inside a <code>table</code>. Another way to think about this is that you want to find a <code>needle</code> in a <code>haystack</code>. More concretely:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co"># Where is `"a"` inside the vector `c("b", "c", "a", "d")`?</span>
<span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"a"</span>, table <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="st">"c"</span>, <span class="st">"a"</span>, <span class="st">"d"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now imagine that I want to use a data frame as my <code>table</code>. I might be interested in locating a few particular rows inside that <code>table</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">needles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">4</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span>
<span class="va">haystack</span> <span class="op">&lt;-</span> <span class="va">df</span>

<span class="va">needles</span>
<span class="co">#&gt; # A tibble: 2 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     3 a     y    </span>
<span class="co">#&gt; 2     4 b     y</span>

<span class="va">haystack</span>
<span class="co">#&gt; # A tibble: 4 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     1 a     x    </span>
<span class="co">#&gt; 2     2 b     x    </span>
<span class="co">#&gt; 3     3 a     y    </span>
<span class="co">#&gt; 4     4 a     x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, the first row of <code>needles</code> is row 3 of the <code>haystack</code>, and the second row of <code>needles</code> is not in the <code>haystack</code> at all. Let’s try with <code><a href="https://rdrr.io/r/base/match.html">match()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">needles</span>, <span class="va">haystack</span><span class="op">)</span>
<span class="co">#&gt; [1] NA NA NA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>🤔 so what happened here? With R’s (completely reasonable) treatment of <code>needles</code> as a vector of columns, it essentially first converted <code>needles</code> and <code>haystack</code> into lists, and then tried to locate each column of <code>needles</code> inside <code>haystack</code>. There were 3 columns, and none of them were found, so <code>NA</code> was returned 3 times. To actually see a match, we could instead provide a list containing the <code>y</code> column of <code>haystack</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">haystack</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, <span class="va">haystack</span><span class="op">)</span>
<span class="co">#&gt; [1] 2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we instead treat both <code>needles</code> and <code>haystack</code> as vectors of rows, what we are really trying to do is find one set of rows inside another set of rows. In vctrs, we’ve created <code><a href="https://vctrs.r-lib.org/reference/vec_match.html">vec_match()</a></code> for this.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_match.html">vec_match</a></span><span class="op">(</span><span class="va">needles</span>, <span class="va">haystack</span><span class="op">)</span>
<span class="co">#&gt; [1]  3 NA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Again, it’s not that anything R is doing is <em>wrong</em>, or even that this is “better”. This just answers a different question by looking at a data frame from a different angle. Additionally, we don’t actually lose anything in vctrs by thinking about data frames in this way. If we want the <code><a href="https://rdrr.io/r/base/match.html">match()</a></code> behavior, we can just <code><a href="https://rdrr.io/r/base/class.html">unclass()</a></code> our data frames to turn them into explicit lists, and then <code><a href="https://vctrs.r-lib.org/reference/vec_match.html">vec_match()</a></code> works exactly the same.</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="aside">Even though <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> and <code><a href="https://rdrr.io/r/base/match.html">match()</a></code> treat data frames as vectors of columns, not all R functions do. At the end of the post I discuss how <code><a href="https://rdrr.io/r/base/split.html">split()</a></code> and <code><a href="https://rdrr.io/r/base/unique.html">unique()</a></code> actually treat them as vectors of rows, and what the vctrs equivalents are.</span></div></div>
</section><section id="slide" class="level2"><h2 class="anchored" data-anchor-id="slide"><code>slide()</code></h2>
<p>Lastly, I’d like to show an example of a package that builds on top of vctrs principles. {slider} is my attempt at a package for working with “window functions”, functions that enable some kind of “rolling” analysis. A moving average, rolling regression, and even a cumulative sum are all examples of usage of window functions.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/slider">slider</a></span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code><a href="https://rdrr.io/pkg/slider/man/slide.html">slide()</a></code> works similarly to <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map()</a></code> in that you provide it a vector, <code>.x</code>, and a function, <code>.f</code>, to apply to each slice of <code>.x</code>. One difference is that you have additional options to control the window of <code>.x</code> you apply <code>.f</code> to. For example, below we construct a sliding window of size 3, asking for “the current value along with 2 values before this one”. The function we apply is to just print out the current value of <code>.x</code> so we can see what is happening.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/slider/man/slide.html">slide</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">~</span><span class="va">.x</span>, .before <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 1 2</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] 1 2 3</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; [1] 2 3 4</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[5]]</span>
<span class="co">#&gt; [1] 3 4 5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could also perform a rolling average by switching <code>~.x</code> for <code>mean</code>, and, like with purrr, replacing <code><a href="https://rdrr.io/pkg/slider/man/slide.html">slide()</a></code> with <code><a href="https://rdrr.io/pkg/slider/man/slide.html">slide_dbl()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/slider/man/slide.html">slide_dbl</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="va">mean</span>, .before <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; [1] 1.0 1.5 2.0 3.0 4.0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Because <code><a href="https://rdrr.io/pkg/slider/man/slide.html">slide()</a></code> builds on vctrs, it is meaningful to talk about the invariants of the function. For example, the size invariant of <code><a href="https://rdrr.io/pkg/slider/man/slide.html">slide()</a></code> is that:</p>
<center>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/slider/man/slide.html">slide</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_size.html">vec_size</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</center>
<p>In other words, <code><a href="https://rdrr.io/pkg/slider/man/slide.html">slide()</a></code> always returns an output that has the same <em>size</em> as its input. This is similar to how <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> works, with one major difference. Like <code><a href="https://rdrr.io/r/base/c.html">c()</a></code>, <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> returns a vector with the same <em>length</em> as its input. This means that <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> treats a data frame as a vector of columns.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span>
<span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">df</span>, <span class="op">~</span><span class="va">.x</span><span class="op">)</span>
<span class="co">#&gt; $x</span>
<span class="co">#&gt; [1] 1 2 3 4</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $y</span>
<span class="co">#&gt; [1] "a" "b" "a" "a"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $z</span>
<span class="co">#&gt; [1] "x" "x" "y" "x"</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A major breakthrough for me was that, to uphold the invariant, <code><a href="https://rdrr.io/pkg/slider/man/slide.html">slide()</a></code> must treat a data frame as a vector of rows, meaning that it should <em>iterate rowwise over .x</em>.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/slider/man/slide.html">slide</a></span><span class="op">(</span><span class="va">df</span>, <span class="op">~</span><span class="va">.x</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; # A tibble: 1 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     1 a     x    </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; # A tibble: 1 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     2 b     x    </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; # A tibble: 1 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     3 a     y    </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[4]]</span>
<span class="co">#&gt; # A tibble: 1 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     4 a     x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This provides an alternative to some <code><a href="https://purrr.tidyverse.org/reference/map2.html">pmap()</a></code> solutions that have been used previously, like the ones in Jenny Bryan’s <a href="https://github.com/jennybc/row-oriented-workflows">GitHub repo</a> of row oriented workflows. Consider this example modified from the repo, where you have a data frame of parameters that you want to pass on to <code><a href="https://rdrr.io/r/stats/Uniform.html">runif()</a></code> in order to call it multiple times with different parameter combinations. Additionally, the column names don’t currently match the argument names of <code><a href="https://rdrr.io/r/stats/Uniform.html">runif()</a></code>, so you either have to rename on the fly, or wrap it with a function.</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  n <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,
  minimum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span>,
  maximum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>

<span class="va">parameters</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>min <span class="op">=</span> <span class="va">minimum</span>, max <span class="op">=</span> <span class="va">maximum</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">pmap</a></span><span class="op">(</span><span class="va">runif</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 0.06936092</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 83.59977 94.83596</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] 342.4437 252.4133 130.5061</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>

<span class="va">my_runif</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">minimum</span>, <span class="va">maximum</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">minimum</span>, <span class="va">maximum</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">pmap</a></span><span class="op">(</span><span class="va">parameters</span>, <span class="va">my_runif</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 0.06936092</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 83.59977 94.83596</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] 342.4437 252.4133 130.5061</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With <code><a href="https://rdrr.io/pkg/slider/man/slide.html">slide()</a></code> being a row wise iterator, you have access to the entire data frame row at each iteration as <code>.x</code>, meaning you can just do:</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/slider/man/slide.html">slide</a></span><span class="op">(</span><span class="va">parameters</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">.x</span><span class="op">$</span><span class="va">n</span>, min <span class="op">=</span> <span class="va">.x</span><span class="op">$</span><span class="va">minimum</span>, max <span class="op">=</span> <span class="va">.x</span><span class="op">$</span><span class="va">maximum</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] 0.06936092</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] 83.59977 94.83596</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] 342.4437 252.4133 130.5061</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="conclusion" class="level2"><h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Treatment of a data frame as a vector of rows is a fairly novel concept in R, because of the way that data frames were originally implemented as a list of columns. But viewing them in this way can be incredibly powerful, especially for data analysis work. I, for one, am looking forward to seeing this concept explored more in the future, both in vctrs and in other packages built on top of it.</p>
</section><section id="extra---unique-and-split" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="extra---unique-and-split">Extra - <code>unique()</code> and <code>split()</code>
</h2>
<p>On the vctrs side, we are trying to be consistent in our treatment of data frames as vectors of rows. However, it is worth mentioning that there are some functions in R where data frames are already treated this way, rather than as a vector of columns. Two in particular are <code><a href="https://rdrr.io/r/base/unique.html">unique()</a></code> and <code><a href="https://rdrr.io/r/base/split.html">split()</a></code>.</p>
<section id="unique" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="unique"><code>unique()</code></h3>
<p>With <code><a href="https://rdrr.io/r/base/unique.html">unique()</a></code>, uniqueness is actually determined using data frame rows, not columns. Looking at columns <code>y</code> and <code>z</code> of <code>df</code>, we can see that rows 1 and 4 are duplicates. Calling <code><a href="https://rdrr.io/r/base/unique.html">unique()</a></code> on this removes the duplicate row.</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">df_yz</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="st">"z"</span><span class="op">)</span><span class="op">]</span>

<span class="va">df_yz</span>
<span class="co">#&gt; # A tibble: 4 × 2</span>
<span class="co">#&gt;   y     z    </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 a     x    </span>
<span class="co">#&gt; 2 b     x    </span>
<span class="co">#&gt; 3 a     y    </span>
<span class="co">#&gt; 4 a     x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">df_yz</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 × 2</span>
<span class="co">#&gt;   y     z    </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 a     x    </span>
<span class="co">#&gt; 2 b     x    </span>
<span class="co">#&gt; 3 a     y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s actually pretty interesting to see how this one works. If you look into <code><a href="https://rdrr.io/r/base/unique.html">unique.data.frame()</a></code>, you’ll see that it calls <code><a href="https://rdrr.io/r/base/duplicated.html">duplicated.data.frame()</a></code>. In there is this somewhat cryptic line that actually does the rowwise check:</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">Map</span>, <span class="fu">`names&lt;-`</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">list</span>, <span class="va">x</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span>, 
  fromLast <span class="op">=</span> <span class="va">fromLast</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Breaking this down, it first combines the function <code><a href="https://rdrr.io/r/base/list.html">list()</a></code> with the data frame to end up with:</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">list</span>, <span class="va">df_yz</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; function (...)  .Primitive("list")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $y</span>
<span class="co">#&gt; [1] "a" "b" "a" "a"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $z</span>
<span class="co">#&gt; [1] "x" "x" "y" "x"</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which it then removes the names of:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">`names&lt;-`</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">list</span>, <span class="va">df_yz</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; function (...)  .Primitive("list")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] "a" "b" "a" "a"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[3]]</span>
<span class="co">#&gt; [1] "x" "x" "y" "x"</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next it uses <code><a href="https://rdrr.io/r/base/do.call.html">do.call()</a></code> to call <code><a href="https://rdrr.io/r/base/funprog.html">Map()</a></code>, which is a wrapper around <code><a href="https://rdrr.io/r/base/mapply.html">mapply()</a></code> meaning that it will repeatedly call <code><a href="https://rdrr.io/r/base/list.html">list()</a></code> on parallel elements of the columns of <code>df_yz</code>. Visually that means we end up with list elements holding the rows, which <code><a href="https://rdrr.io/r/base/duplicated.html">duplicated()</a></code> is then run on to locate the duplicates.</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">Map</span>, <span class="fu">`names&lt;-`</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">list</span>, <span class="va">df_yz</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; $a</span>
<span class="co">#&gt; $a[[1]]</span>
<span class="co">#&gt; [1] "a"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $a[[2]]</span>
<span class="co">#&gt; [1] "x"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $b</span>
<span class="co">#&gt; $b[[1]]</span>
<span class="co">#&gt; [1] "b"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $b[[2]]</span>
<span class="co">#&gt; [1] "x"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $a</span>
<span class="co">#&gt; $a[[1]]</span>
<span class="co">#&gt; [1] "a"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $a[[2]]</span>
<span class="co">#&gt; [1] "y"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $a</span>
<span class="co">#&gt; $a[[1]]</span>
<span class="co">#&gt; [1] "a"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $a[[2]]</span>
<span class="co">#&gt; [1] "x"</span>

<span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">Map</span>, <span class="fu">`names&lt;-`</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">list</span>, <span class="va">df_yz</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] FALSE FALSE FALSE  TRUE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In vctrs there is <code><a href="https://vctrs.r-lib.org/reference/vec_unique.html">vec_unique()</a></code>. Because <code><a href="https://rdrr.io/r/base/unique.html">unique()</a></code> already works row wise, they are essentially equivalent in terms of functionality with data frames. However, there are two key differences. First, because <code><a href="https://vctrs.r-lib.org/reference/vec_unique.html">vec_unique()</a></code>’s handling of data frames is in C, it does end up being faster.</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co"># row bind df_yz 10000 times, making a 40000 row data frame</span>
<span class="va">large_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_bind.html">vec_rbind</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">df_yz</span><span class="op">)</span>, <span class="fl">10000</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">large_df</span><span class="op">)</span>
<span class="co">#&gt; [1] 40000     2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html">mark</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">large_df</span><span class="op">)</span>,
  <span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_unique.html">vec_unique</a></span><span class="op">(</span><span class="va">large_df</span><span class="op">)</span>
<span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co">## # A tibble: 2 x 6</span>
<span class="co">##   expression                min   median `itr/sec` mem_alloc `gc/sec`</span>
<span class="co">##   &lt;bch:expr&gt;           &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span>
<span class="co">## 1 unique(large_df)      28.38ms   31.6ms      31.7    1.42MB     137.</span>
<span class="co">## 2 vec_unique(large_df)   4.34ms    4.6ms     216.   429.61KB       0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Second, <code><a href="https://rdrr.io/r/base/unique.html">unique()</a></code> doesn’t handle the idea of a <em>packed</em> data frame well. This is a relatively new idea in the tidyverse, and it isn’t one that we want to expose users to very much yet, but it is powerful. A packed data frame is a data frame where one of the columns is another data frame. This is different from a list-column of data frames. You can create one by providing <code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code> another <code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code> as a column along with a name for that data frame column.</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">df_packed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
    a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, 
    b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>
  <span class="op">)</span>, 
  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Both `$a` and `$b` are columns in the data frame column, `x`</span>
<span class="va">df_packed</span>
<span class="co">#&gt; # A tibble: 4 × 2</span>
<span class="co">#&gt;     x$a    $b     y</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     1     1     1</span>
<span class="co">#&gt; 2     1     1     1</span>
<span class="co">#&gt; 3     1     3     1</span>
<span class="co">#&gt; 4     3     3     2</span>

<span class="co"># `x` itself is another data frame</span>
<span class="va">df_packed</span><span class="op">$</span><span class="va">x</span>
<span class="co">#&gt; # A tibble: 4 × 2</span>
<span class="co">#&gt;       a     b</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     1     1</span>
<span class="co">#&gt; 2     1     1</span>
<span class="co">#&gt; 3     1     3</span>
<span class="co">#&gt; 4     3     3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="aside">Even though you can create one of these, as an end user there isn’t much yet that you can do with them, so you shouldn’t have to worry about this very much.</span></div></div>
<p>Looking at <code>df_packed</code>, the unique rows are 1, 3, and 4, which <code><a href="https://vctrs.r-lib.org/reference/vec_unique.html">vec_unique()</a></code> can determine, but <code><a href="https://rdrr.io/r/base/unique.html">unique()</a></code> doesn’t correctly pick up on.</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_unique.html">vec_unique</a></span><span class="op">(</span><span class="va">df_packed</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 × 2</span>
<span class="co">#&gt;     x$a    $b     y</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     1     1     1</span>
<span class="co">#&gt; 2     1     3     1</span>
<span class="co">#&gt; 3     3     3     2</span>

<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">df_packed</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 × 2</span>
<span class="co">#&gt;     x$a    $b     y</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     1     1     1</span>
<span class="co">#&gt; 2     1     1     1</span>
<span class="co">#&gt; 3     3     3     2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="page-columns page-full"><p>As packed data frames become more prevalent in the tidyverse, it will be nice to have tools that handle them consistently. </p><div class="no-row-height column-margin column-container"><span class="aside">For example, there is already <code><a href="https://tidyr.tidyverse.org/reference/pack.html">tidyr::pack()</a></code> and <code><a href="https://tidyr.tidyverse.org/reference/pack.html">tidyr::unpack()</a></code>, which helps power <code><a href="https://tidyr.tidyverse.org/reference/nest.html">tidyr::unnest()</a></code>.</span></div></div>
</section><section id="split" class="level3"><h3 class="anchored" data-anchor-id="split"><code>split()</code></h3>
<p><code>split(x, by)</code> will divide up <code>x</code> into groups using <code>by</code> to determine where the unique groups are. It assumes <code>by</code> is a factor, and will coerce your input to a factor if it isn’t already one. Like <code><a href="https://rdrr.io/r/base/unique.html">unique()</a></code>, it will slice up a data frame by rows rather than by columns.</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>
<span class="co">#&gt; $a</span>
<span class="co">#&gt; # A tibble: 3 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     1 a     x    </span>
<span class="co">#&gt; 2     3 a     y    </span>
<span class="co">#&gt; 3     4 a     x    </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $b</span>
<span class="co">#&gt; # A tibble: 1 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     2 b     x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One thing about <code><a href="https://rdrr.io/r/base/split.html">split()</a></code> is that it uses the unique values as labels on the list elements. To take a slightly different approach, <code><a href="https://vctrs.r-lib.org/reference/vec_split.html">vec_split()</a></code> was created, which returns a data frame instead, holding the unique <code>key</code> values in their own parallel column. <code><a href="https://vctrs.r-lib.org/reference/vec_split.html">vec_split()</a></code> returns a data frame to keep vctrs lightweight, but the print method for these can be a little complex, and I think tibble’s print method does a nicer job.</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">df_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_split.html">vec_split</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>
<span class="va">df_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">df_split</span><span class="op">)</span>

<span class="va">df_split</span>
<span class="co">#&gt; # A tibble: 2 × 2</span>
<span class="co">#&gt;   key   val             </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;list&gt;          </span>
<span class="co">#&gt; 1 a     &lt;tibble [3 × 3]&gt;</span>
<span class="co">#&gt; 2 b     &lt;tibble [1 × 3]&gt;</span>

<span class="va">df_split</span><span class="op">$</span><span class="va">val</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; # A tibble: 3 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     1 a     x    </span>
<span class="co">#&gt; 2     3 a     y    </span>
<span class="co">#&gt; 3     4 a     x    </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; # A tibble: 1 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     2 b     x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One useful feature of <code><a href="https://vctrs.r-lib.org/reference/vec_split.html">vec_split()</a></code> is that it doesn’t expect a factor as the second argument, which means that a data frame can be provided to split by, and since uniqueness is determined row wise this allows us to split by multiple columns. The <code>key</code> ends up as the unique rows of the data frame, meaning that the <code>key</code> is actually a data frame column, creating a packed data frame!</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">df_multi_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vctrs.r-lib.org/reference/vec_split.html">vec_split</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="st">"z"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="va">df_multi_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">df_multi_split</span><span class="op">)</span>

<span class="va">df_multi_split</span>
<span class="co">#&gt; # A tibble: 3 × 2</span>
<span class="co">#&gt;   key$y $z    val             </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;list&gt;          </span>
<span class="co">#&gt; 1 a     x     &lt;tibble [2 × 3]&gt;</span>
<span class="co">#&gt; 2 b     x     &lt;tibble [1 × 3]&gt;</span>
<span class="co">#&gt; 3 a     y     &lt;tibble [1 × 3]&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Technically you can provide <code><a href="https://rdrr.io/r/base/split.html">split()</a></code> a data frame to split <code>by</code>, but remember that it will try and treat it like a factor! Since the data frame is technically a list, it will run <code><a href="https://rdrr.io/r/base/interaction.html">interaction()</a></code> on it first to get a single factor it can use to split by. Notice that this gives a level for <code>b.y</code> which does not exist as a row in our data frame.</p>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="st">"z"</span><span class="op">)</span><span class="op">]</span>
<span class="co">#&gt; # A tibble: 4 × 2</span>
<span class="co">#&gt;   y     z    </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1 a     x    </span>
<span class="co">#&gt; 2 b     x    </span>
<span class="co">#&gt; 3 a     y    </span>
<span class="co">#&gt; 4 a     x</span>

<span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="st">"z"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; [1] a.x b.x a.y a.x</span>
<span class="co">#&gt; Levels: a.x b.x a.y b.y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This results in the following split, with a <code>b.y</code> element with no rows which we may or may not have wanted.</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="st">"z"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; $a.x</span>
<span class="co">#&gt; # A tibble: 2 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     1 a     x    </span>
<span class="co">#&gt; 2     4 a     x    </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $b.x</span>
<span class="co">#&gt; # A tibble: 1 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     2 b     x    </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $a.y</span>
<span class="co">#&gt; # A tibble: 1 × 3</span>
<span class="co">#&gt;       x y     z    </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;</span>
<span class="co">#&gt; 1     3 a     y    </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $b.y</span>
<span class="co">#&gt; # A tibble: 0 × 3</span>
<span class="co">#&gt; # … with 3 variables: x &lt;int&gt;, y &lt;chr&gt;, z &lt;chr&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>