<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.344">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Davis Vaughan">
<meta name="dcterms.date" content="2022-04-20">
<title>Davis Vaughan - ivs 0.1.0</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<script src="../../site_libs/quarto-nav/quarto-nav.js"></script><script src="../../site_libs/quarto-nav/headroom.min.js"></script><script src="../../site_libs/clipboard/clipboard.min.js"></script><meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script><script src="../../site_libs/quarto-search/fuse.min.js"></script><script src="../../site_libs/quarto-search/quarto-search.js"></script><script src="../../site_libs/quarto-html/quarto.js"></script><script src="../../site_libs/quarto-html/popper.min.js"></script><script src="../../site_libs/quarto-html/tippy.umd.min.js"></script><script src="../../site_libs/quarto-html/anchor.min.js"></script><link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link id="quarto-text-highlighting-styles" href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script><link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Davis Vaughan</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html">Posts</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/DavisVaughan"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/dvaughan32"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
<div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">ivs 0.1.0</h1>
                </div>
  </div>
    
  



  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Davis Vaughan </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 20, 2022</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#creating-an-interval-vector" id="toc-creating-an-interval-vector" class="nav-link active" data-scroll-target="#creating-an-interval-vector">Creating an interval vector</a></li>
  <li><a href="#grouping-by-overlaps" id="toc-grouping-by-overlaps" class="nav-link" data-scroll-target="#grouping-by-overlaps">Grouping by overlaps</a></li>
  <li><a href="#locating-overlaps" id="toc-locating-overlaps" class="nav-link" data-scroll-target="#locating-overlaps">Locating overlaps</a></li>
  <li><a href="#counting-overlaps" id="toc-counting-overlaps" class="nav-link" data-scroll-target="#counting-overlaps">Counting overlaps</a></li>
  <li><a href="#set-operations" id="toc-set-operations" class="nav-link" data-scroll-target="#set-operations">Set operations</a></li>
  <li><a href="#inspiration" id="toc-inspiration" class="nav-link" data-scroll-target="#inspiration">Inspiration</a></li>
  </ul></nav>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><p>I’m very excited to announce the first release of <a href="https://davisvaughan.github.io/ivs/">ivs</a> (said, “eye-vees”), a package dedicated to working with intervals. It introduces a new vector type, the <strong>i</strong>nterval <strong>v</strong>ector, which is generally just referred to as an <strong>iv</strong> throughout the package.</p>
<p>You can install ivs from CRAN with:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"ivs"</span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ivs is loaded with tools for working with interval vectors. In particular, it provides utilities for:</p>
<ul>
<li><p>Grouping / Merging overlapping intervals.</p></li>
<li><p>Splitting intervals on overlapping endpoints.</p></li>
<li><p>Determining how two ivs are related, i.e.&nbsp;does one interval precede, follow, or overlap another?</p></li>
<li><p>Applying set theoretical operations like intersection, union, and complement on two ivs.</p></li>
</ul>
<p>The rest of this blog post will explore some of this functionality through a number of practical examples.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/ivs">ivs</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://clock.r-lib.org">clock</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="creating-an-interval-vector" class="level2"><h2 class="anchored" data-anchor-id="creating-an-interval-vector">Creating an interval vector</h2>
<p>Interval vectors are typically created from two parallel vectors representing the starts (inclusive) and ends (exclusive) of the intervals:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">starts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">ends</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">9</span>, <span class="fl">12</span>, <span class="fl">4</span><span class="op">)</span>

<span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv.html">iv</a></span><span class="op">(</span><span class="va">starts</span>, <span class="va">ends</span><span class="op">)</span>
<span class="co">#&gt; &lt;iv&lt;double&gt;[4]&gt;</span>
<span class="co">#&gt; [1] [1, 6)   [5, 9)   [10, 12) [3, 4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ivs is designed to play nicely with the tidyverse, and most of the time <code>start</code> and <code>end</code> will already be columns in an existing data frame.</p>
<p>ivs is also designed to be <em>generic</em>. It is built on top of <a href="https://vctrs.r-lib.org">vctrs</a>, which gives it the ability to use any comparable type as the start/end vectors.</p>
<p>This includes dates and date-times:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">starts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2019-01-01"</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0</span><span class="op">:</span><span class="fl">2</span>
<span class="va">ends</span> <span class="op">&lt;-</span> <span class="va">starts</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>

<span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv.html">iv</a></span><span class="op">(</span><span class="va">starts</span>, <span class="va">ends</span><span class="op">)</span>
<span class="co">#&gt; &lt;iv&lt;date&gt;[3]&gt;</span>
<span class="co">#&gt; [1] [2019-01-01, 2019-01-03) [2019-01-02, 2019-01-07) [2019-01-03, 2019-01-13)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>the <code>integer64</code> type from <a href="https://cran.r-project.org/web/packages/bit64/index.html">bit64</a>:</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu">bit64</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bit64/man/as.integer64.character.html">as.integer64</a></span><span class="op">(</span><span class="st">"900000000000"</span><span class="op">)</span>
<span class="va">end</span> <span class="op">&lt;-</span> <span class="va">start</span> <span class="op">+</span> <span class="fl">1234</span>

<span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv.html">iv</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span>
<span class="co">#&gt; &lt;iv&lt;integer64&gt;[1]&gt;</span>
<span class="co">#&gt; [1] [900000000000, 900000001234)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or the <code>year_month_day</code> type from <a href="https://clock.r-lib.org">clock</a>:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://clock.r-lib.org/reference/year_month_day.html">year_month_day</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2019</span>, <span class="fl">2020</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://clock.r-lib.org/reference/year_month_day.html">year_month_day</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2020</span>, <span class="fl">2020</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv.html">iv</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span>
<span class="co">#&gt; &lt;iv&lt;year_month_day&lt;month&gt;&gt;[2]&gt;</span>
<span class="co">#&gt; [1] [2019-01, 2020-02) [2020-03, 2020-06)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Interval vectors are always composed of right-open intervals, and each individual interval in the vector must satisfy <code>start &lt; end</code>. I say more on the practical reasons for this <a href="https://davisvaughan.github.io/ivs/articles/ivs.html#structure">in the Getting Started vignette</a> if you are interested in learning more.</p>
</section><section id="grouping-by-overlaps" class="level2"><h2 class="anchored" data-anchor-id="grouping-by-overlaps">Grouping by overlaps</h2>
<p>One of the key features of ivs is that it makes identifying and merging overlaps as easy as possible.</p>
<p>Imagine you work for AWS (Amazon Web Services) and you have a database that tracks costs racked up by users that are utilizing your services. The date ranges below represent the intervals over which the cost was accrued, and the intervals don’t overlap for a given <code>(user, service)</code> pair.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">costs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span>
  <span class="op">~</span><span class="va">user</span>, <span class="op">~</span><span class="va">service</span>, <span class="op">~</span><span class="va">from</span>, <span class="op">~</span><span class="va">to</span>, <span class="op">~</span><span class="va">cost</span>,
  <span class="fl">1L</span>, <span class="st">"a"</span>, <span class="st">"2019-01-01"</span>, <span class="st">"2019-01-05"</span>, <span class="fl">200.5</span>,
  <span class="fl">1L</span>, <span class="st">"a"</span>, <span class="st">"2019-01-12"</span>, <span class="st">"2019-01-13"</span>, <span class="fl">15.6</span>,
  <span class="fl">1L</span>, <span class="st">"b"</span>, <span class="st">"2019-01-03"</span>, <span class="st">"2019-01-10"</span>, <span class="fl">500.3</span>,
  <span class="fl">2L</span>, <span class="st">"a"</span>, <span class="st">"2019-01-02"</span>, <span class="st">"2019-01-03"</span>, <span class="fl">25.6</span>,
  <span class="fl">2L</span>, <span class="st">"b"</span>, <span class="st">"2019-01-01"</span>, <span class="st">"2019-01-06"</span>, <span class="fl">217.3</span>,
  <span class="fl">2L</span>, <span class="st">"c"</span>, <span class="st">"2019-01-03"</span>, <span class="st">"2019-01-04"</span>, <span class="fl">30</span>,
  <span class="fl">2L</span>, <span class="st">"c"</span>, <span class="st">"2019-01-05"</span>, <span class="st">"2019-01-07"</span>, <span class="fl">66.2</span>
<span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">from</span><span class="op">)</span>,
    to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">to</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">costs</span>
<span class="co">#&gt; # A tibble: 7 × 5</span>
<span class="co">#&gt;    user service from       to          cost</span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;   &lt;date&gt;     &lt;date&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1     1 a       2019-01-01 2019-01-05 200. </span>
<span class="co">#&gt; 2     1 a       2019-01-12 2019-01-13  15.6</span>
<span class="co">#&gt; 3     1 b       2019-01-03 2019-01-10 500. </span>
<span class="co">#&gt; 4     2 a       2019-01-02 2019-01-03  25.6</span>
<span class="co">#&gt; 5     2 b       2019-01-01 2019-01-06 217. </span>
<span class="co">#&gt; 6     2 c       2019-01-03 2019-01-04  30  </span>
<span class="co">#&gt; 7     2 c       2019-01-05 2019-01-07  66.2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You might be interested in identifying the contiguous blocks of time that a particular service was in use, regardless of who was using it. In graphical form, that might look like this (notice how the overlapping <code>a</code> and overlapping <code>b</code> intervals have been combined):</p>
<p><img src="omnigraffle/ivs/groups.png" class="img-fluid"></p>
<p>To solve this problem, we will first convert our <code>from/to</code> dates into a true interval vector using <code><a href="https://davisvaughan.github.io/ivs/reference/iv.html">iv()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">costs</span> <span class="op">&lt;-</span> <span class="va">costs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    interval <span class="op">=</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv.html">iv</a></span><span class="op">(</span><span class="va">from</span>, <span class="va">to</span><span class="op">)</span>, 
    .keep <span class="op">=</span> <span class="st">"unused"</span>
  <span class="op">)</span>

<span class="va">costs</span>
<span class="co">#&gt; # A tibble: 7 × 4</span>
<span class="co">#&gt;    user service  cost                 interval</span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;   &lt;dbl&gt;               &lt;iv&lt;date&gt;&gt;</span>
<span class="co">#&gt; 1     1 a       200.  [2019-01-01, 2019-01-05)</span>
<span class="co">#&gt; 2     1 a        15.6 [2019-01-12, 2019-01-13)</span>
<span class="co">#&gt; 3     1 b       500.  [2019-01-03, 2019-01-10)</span>
<span class="co">#&gt; 4     2 a        25.6 [2019-01-02, 2019-01-03)</span>
<span class="co">#&gt; 5     2 b       217.  [2019-01-01, 2019-01-06)</span>
<span class="co">#&gt; 6     2 c        30   [2019-01-03, 2019-01-04)</span>
<span class="co">#&gt; 7     2 c        66.2 [2019-01-05, 2019-01-07)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we’ll use <code><a href="https://davisvaughan.github.io/ivs/reference/iv-groups.html">iv_groups()</a></code> on the <code>interval</code> column to merge together all of the overlapping intervals. It returns the intervals that remain after all of the overlaps have been merged. Since we want to do this on a per-service basis, we’ll group by <code>service</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">services</span> <span class="op">&lt;-</span> <span class="va">costs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">service</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>interval <span class="op">=</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv-groups.html">iv_groups</a></span><span class="op">(</span><span class="va">interval</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"keep"</span><span class="op">)</span>

<span class="co"># Note how this merged the two overlapping `service == "b"` intervals</span>
<span class="co"># of [2019-01-03, 2019-01-10) and [2019-01-01, 2019-01-06) into one</span>
<span class="co"># wider interval of [2019-01-01, 2019-01-10)</span>
<span class="va">services</span> 
<span class="co">#&gt; # A tibble: 5 × 2</span>
<span class="co">#&gt; # Groups:   service [3]</span>
<span class="co">#&gt;   service                 interval</span>
<span class="co">#&gt;   &lt;chr&gt;                 &lt;iv&lt;date&gt;&gt;</span>
<span class="co">#&gt; 1 a       [2019-01-01, 2019-01-05)</span>
<span class="co">#&gt; 2 a       [2019-01-12, 2019-01-13)</span>
<span class="co">#&gt; 3 b       [2019-01-01, 2019-01-10)</span>
<span class="co">#&gt; 4 c       [2019-01-03, 2019-01-04)</span>
<span class="co">#&gt; 5 c       [2019-01-05, 2019-01-07)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we used <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> here rather than <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>. <code><a href="https://davisvaughan.github.io/ivs/reference/iv-groups.html">iv_groups()</a></code> will return a new interval vector that is <em>shorter</em> than the original input, so we can’t use <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>. Instead, we are taking advantage of the relatively new feature of <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> which allows you to return a per-group result with length &gt;1.</p>
<p>You also might be interested in the intervals corresponding to when a service <em>wasn’t</em> being used. I’m getting ahead of myself a little bit, but you could use one of the set operation functions, <code><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_complement()</a></code>, for this. We’ll provide (optional) lower and upper bounds for the universe over which to take the complement.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">lower</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2019-01-01"</span><span class="op">)</span>
<span class="va">upper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2019-01-15"</span><span class="op">)</span>

<span class="va">services</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    not_in_use <span class="op">=</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_complement</a></span><span class="op">(</span><span class="va">interval</span>, lower <span class="op">=</span> <span class="va">lower</span>, upper <span class="op">=</span> <span class="va">upper</span><span class="op">)</span>,
    .groups <span class="op">=</span> <span class="st">"drop"</span>
  <span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 2</span>
<span class="co">#&gt;   service               not_in_use</span>
<span class="co">#&gt;   &lt;chr&gt;                 &lt;iv&lt;date&gt;&gt;</span>
<span class="co">#&gt; 1 a       [2019-01-05, 2019-01-12)</span>
<span class="co">#&gt; 2 a       [2019-01-13, 2019-01-15)</span>
<span class="co">#&gt; 3 b       [2019-01-10, 2019-01-15)</span>
<span class="co">#&gt; 4 c       [2019-01-01, 2019-01-03)</span>
<span class="co">#&gt; 5 c       [2019-01-04, 2019-01-05)</span>
<span class="co">#&gt; 6 c       [2019-01-07, 2019-01-15)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s go back to <code>costs</code> and answer one more question. Let’s say you don’t care about <code>service</code> anymore, and you just want to aggregate the costs over any contiguous date range for a particular <code>user</code>. For example, user <code>1</code> used service <code>a</code> and <code>b</code> simultaneously, so you’d like to combine those costs into a single larger interval.</p>
<p>We can try to use <code><a href="https://davisvaughan.github.io/ivs/reference/iv-groups.html">iv_groups()</a></code> here, but this isn’t quite what we need because it doesn’t give us a chance to aggregate the costs:</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">costs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">user</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>interval <span class="op">=</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv-groups.html">iv_groups</a></span><span class="op">(</span><span class="va">interval</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 × 2</span>
<span class="co">#&gt;    user                 interval</span>
<span class="co">#&gt;   &lt;int&gt;               &lt;iv&lt;date&gt;&gt;</span>
<span class="co">#&gt; 1     1 [2019-01-01, 2019-01-10)</span>
<span class="co">#&gt; 2     1 [2019-01-12, 2019-01-13)</span>
<span class="co">#&gt; 3     2 [2019-01-01, 2019-01-07)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Instead, we’ll use <code><a href="https://davisvaughan.github.io/ivs/reference/iv-groups.html">iv_identify_group()</a></code>. This returns a new interval vector that has the same length as the old one, and identifies which of the 3 groups returned above that the original interval falls in.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">users</span> <span class="op">&lt;-</span> <span class="va">costs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">service</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">user</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>user_interval <span class="op">=</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv-groups.html">iv_identify_group</a></span><span class="op">(</span><span class="va">interval</span><span class="op">)</span><span class="op">)</span>

<span class="va">users</span>
<span class="co">#&gt; # A tibble: 7 × 4</span>
<span class="co">#&gt; # Groups:   user [2]</span>
<span class="co">#&gt;    user  cost                 interval            user_interval</span>
<span class="co">#&gt;   &lt;int&gt; &lt;dbl&gt;               &lt;iv&lt;date&gt;&gt;               &lt;iv&lt;date&gt;&gt;</span>
<span class="co">#&gt; 1     1 200.  [2019-01-01, 2019-01-05) [2019-01-01, 2019-01-10)</span>
<span class="co">#&gt; 2     1  15.6 [2019-01-12, 2019-01-13) [2019-01-12, 2019-01-13)</span>
<span class="co">#&gt; 3     1 500.  [2019-01-03, 2019-01-10) [2019-01-01, 2019-01-10)</span>
<span class="co">#&gt; 4     2  25.6 [2019-01-02, 2019-01-03) [2019-01-01, 2019-01-07)</span>
<span class="co">#&gt; 5     2 217.  [2019-01-01, 2019-01-06) [2019-01-01, 2019-01-07)</span>
<span class="co">#&gt; 6     2  30   [2019-01-03, 2019-01-04) [2019-01-01, 2019-01-07)</span>
<span class="co">#&gt; 7     2  66.2 [2019-01-05, 2019-01-07) [2019-01-01, 2019-01-07)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This gives us something we can group on so we can <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> up the costs:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">users</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">user</span>, <span class="va">user_interval</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>cost <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cost</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 × 3</span>
<span class="co">#&gt;    user            user_interval  cost</span>
<span class="co">#&gt;   &lt;int&gt;               &lt;iv&lt;date&gt;&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     1 [2019-01-01, 2019-01-10) 701. </span>
<span class="co">#&gt; 2     1 [2019-01-12, 2019-01-13)  15.6</span>
<span class="co">#&gt; 3     2 [2019-01-01, 2019-01-07) 339.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="locating-overlaps" class="level2"><h2 class="anchored" data-anchor-id="locating-overlaps">Locating overlaps</h2>
<p>While <code><a href="https://davisvaughan.github.io/ivs/reference/iv-groups.html">iv_groups()</a></code> is useful for working with overlaps in a single interval vector, you might also find yourself in a situation where you need to identify relationships between multiple vectors. This might be between two interval vectors (where you are detecting if one overlaps another in some way) or between a regular vector and an interval vector (where you want to know if the elements of the vector lie between any of the intervals).</p>
<p>For example, you might want to locate where these two interval vectors overlap:</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="co"># iv_pairs() is a useful way to create small ivs from individual intervals</span>
<span class="va">needles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv.html">iv_pairs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">7</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span>
<span class="va">needles</span>
<span class="co">#&gt; &lt;iv&lt;double&gt;[3]&gt;</span>
<span class="co">#&gt; [1] [1, 5)   [3, 7)   [10, 12)</span>

<span class="va">haystack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv.html">iv_pairs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fl">13</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>
<span class="va">haystack</span>
<span class="co">#&gt; &lt;iv&lt;double&gt;[5]&gt;</span>
<span class="co">#&gt; [1] [1, 6)   [12, 13) [1, 2)   [7, 8)   [4, 5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="omnigraffle/ivs/locate.png" class="img-fluid"></p>
<p>Ideally you’d like to be notified of the fact that <code>[1, 5)</code> from <code>needles</code> overlaps with <code>[1, 6)</code>, <code>[1, 2)</code> and <code>[4, 5)</code> from <code>haystack</code>. <code><a href="https://davisvaughan.github.io/ivs/reference/relation-locate.html">iv_locate_overlaps()</a></code> allows you to do exactly this, and returns a data frame of the locations where the two interval vectors overlap.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">locations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/relation-locate.html">iv_locate_overlaps</a></span><span class="op">(</span><span class="va">needles</span>, <span class="va">haystack</span><span class="op">)</span>
<span class="va">locations</span>
<span class="co">#&gt;   needles haystack</span>
<span class="co">#&gt; 1       1        1</span>
<span class="co">#&gt; 2       1        3</span>
<span class="co">#&gt; 3       1        5</span>
<span class="co">#&gt; 4       2        1</span>
<span class="co">#&gt; 5       2        5</span>
<span class="co">#&gt; 6       3       NA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can hand this data frame off to <code><a href="https://davisvaughan.github.io/ivs/reference/iv_align.html">iv_align()</a></code>, along with the original inputs, and it will join them together based on their overlapping locations:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv_align.html">iv_align</a></span><span class="op">(</span><span class="va">needles</span>, <span class="va">haystack</span>, locations <span class="op">=</span> <span class="va">locations</span><span class="op">)</span>
<span class="co">#&gt;    needles haystack</span>
<span class="co">#&gt; 1   [1, 5)   [1, 6)</span>
<span class="co">#&gt; 2   [1, 5)   [1, 2)</span>
<span class="co">#&gt; 3   [1, 5)   [4, 5)</span>
<span class="co">#&gt; 4   [3, 7)   [1, 6)</span>
<span class="co">#&gt; 5   [3, 7)   [4, 5)</span>
<span class="co">#&gt; 6 [10, 12) [NA, NA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You’ll notice that <code>[10, 12)</code> from <code>needles</code> didn’t overlap with anything from <code>haystack</code>, so it was aligned with a missing interval.</p>
<p><code><a href="https://davisvaughan.github.io/ivs/reference/relation-locate.html">iv_locate_overlaps()</a></code> has a number of options to tweak the type of overlap you are looking for. For example, you can change the <code>type</code> from its default value of <code>"any"</code> overlap to instead restrict it to cases where <code>needles</code> is <code>"within"</code> the <code>haystack</code> intervals, or to cases where it <code>"contains"</code> them. You can also change what happens when there is <code>no_match</code>, like with <code>[10, 12)</code> from above. If you don’t want to see unmatched needles in the result, you can <code>"drop"</code> them:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">locations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/relation-locate.html">iv_locate_overlaps</a></span><span class="op">(</span><span class="va">needles</span>, <span class="va">haystack</span>, no_match <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span>
<span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv_align.html">iv_align</a></span><span class="op">(</span><span class="va">needles</span>, <span class="va">haystack</span>, locations <span class="op">=</span> <span class="va">locations</span><span class="op">)</span>
<span class="co">#&gt;   needles haystack</span>
<span class="co">#&gt; 1  [1, 5)   [1, 6)</span>
<span class="co">#&gt; 2  [1, 5)   [1, 2)</span>
<span class="co">#&gt; 3  [1, 5)   [4, 5)</span>
<span class="co">#&gt; 4  [3, 7)   [1, 6)</span>
<span class="co">#&gt; 5  [3, 7)   [4, 5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Other related functionality includes:</p>
<ul>
<li><p><code><a href="https://davisvaughan.github.io/ivs/reference/relation-locate.html">iv_locate_precedes()</a></code> and <code><a href="https://davisvaughan.github.io/ivs/reference/relation-locate.html">iv_locate_follows()</a></code> to determine where one iv precedes or follows another.</p></li>
<li><p><code><a href="https://davisvaughan.github.io/ivs/reference/iv_locate_between.html">iv_locate_between()</a></code> to determine if elements of a vector fall <em>between</em> the intervals in an iv.</p></li>
<li><p><code><a href="https://davisvaughan.github.io/ivs/reference/relation-detect.html">iv_overlaps()</a></code> which works like <code><a href="https://davisvaughan.github.io/ivs/reference/relation-locate.html">iv_locate_overlaps()</a></code> but just returns a logical vector detecting if there were any overlapping intervals at all.</p></li>
</ul></section><section id="counting-overlaps" class="level2"><h2 class="anchored" data-anchor-id="counting-overlaps">Counting overlaps</h2>
<p>Sometimes you just need the counts of the number of overlaps rather than the actual locations of them. For example, say your business has a subscription service and you’d like to compute a rolling monthly count of the total number of currently active subscriptions (i.e.&nbsp;in January 2019, how many subscriptions were active?). Customers are only allowed to have one subscription active at once, but they may cancel it and reactivate it at any time. If a customer was active at any point during the month, then they are counted in that month.</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">enrollments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span>
  <span class="op">~</span><span class="va">name</span>,      <span class="op">~</span><span class="va">start</span>,          <span class="op">~</span><span class="va">end</span>,
  <span class="st">"Amy"</span>,      <span class="st">"1, Jan, 2017"</span>,  <span class="st">"30, Jul, 2018"</span>,
  <span class="st">"Franklin"</span>, <span class="st">"1, Jan, 2017"</span>,  <span class="st">"19, Feb, 2017"</span>,
  <span class="st">"Franklin"</span>, <span class="st">"5, Jun, 2017"</span>,  <span class="st">"4, Feb, 2018"</span>,
  <span class="st">"Franklin"</span>, <span class="st">"21, Oct, 2018"</span>, <span class="st">"9, Mar, 2019"</span>,
  <span class="st">"Samir"</span>,    <span class="st">"1, Jan, 2017"</span>,  <span class="st">"4, Feb, 2017"</span>,
  <span class="st">"Samir"</span>,    <span class="st">"5, Apr, 2017"</span>,  <span class="st">"12, Jun, 2018"</span>
<span class="op">)</span>

<span class="co"># Parse these into "day" precision year-month-day objects</span>
<span class="va">enrollments</span> <span class="op">&lt;-</span> <span class="va">enrollments</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    start <span class="op">=</span> <span class="fu"><a href="https://clock.r-lib.org/reference/year_month_day_parse.html">year_month_day_parse</a></span><span class="op">(</span><span class="va">start</span>, format <span class="op">=</span> <span class="st">"%d, %b, %Y"</span><span class="op">)</span>,
    end <span class="op">=</span> <span class="fu"><a href="https://clock.r-lib.org/reference/year_month_day_parse.html">year_month_day_parse</a></span><span class="op">(</span><span class="va">end</span>, format <span class="op">=</span> <span class="st">"%d, %b, %Y"</span><span class="op">)</span>,
  <span class="op">)</span>

<span class="va">enrollments</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   name     start      end       </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;ymd&lt;day&gt;&gt; &lt;ymd&lt;day&gt;&gt;</span>
<span class="co">#&gt; 1 Amy      2017-01-01 2018-07-30</span>
<span class="co">#&gt; 2 Franklin 2017-01-01 2017-02-19</span>
<span class="co">#&gt; 3 Franklin 2017-06-05 2018-02-04</span>
<span class="co">#&gt; 4 Franklin 2018-10-21 2019-03-09</span>
<span class="co">#&gt; 5 Samir    2017-01-01 2017-02-04</span>
<span class="co">#&gt; 6 Samir    2017-04-05 2018-06-12</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Even though we have day precision information, we only actually need month precision intervals to answer this question. We’ll use <code><a href="https://clock.r-lib.org/reference/calendar_narrow.html">calendar_narrow()</a></code> from clock to convert our <code>"day"</code> precision dates to <code>"month"</code> precision ones to reflect this. We’ll also add 1 month to the <code>end</code> intervals to reflect the fact that the end month is open (remember, ivs are half-open).</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">enrollments</span> <span class="op">&lt;-</span> <span class="va">enrollments</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
    start <span class="op">=</span> <span class="fu"><a href="https://clock.r-lib.org/reference/calendar_narrow.html">calendar_narrow</a></span><span class="op">(</span><span class="va">start</span>, <span class="st">"month"</span><span class="op">)</span>,
    end <span class="op">=</span> <span class="fu"><a href="https://clock.r-lib.org/reference/calendar_narrow.html">calendar_narrow</a></span><span class="op">(</span><span class="va">end</span>, <span class="st">"month"</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1L</span>
  <span class="op">)</span>

<span class="va">enrollments</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   name     start        end         </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;ymd&lt;month&gt;&gt; &lt;ymd&lt;month&gt;&gt;</span>
<span class="co">#&gt; 1 Amy      2017-01      2018-08     </span>
<span class="co">#&gt; 2 Franklin 2017-01      2017-03     </span>
<span class="co">#&gt; 3 Franklin 2017-06      2018-03     </span>
<span class="co">#&gt; 4 Franklin 2018-10      2019-04     </span>
<span class="co">#&gt; 5 Samir    2017-01      2017-03     </span>
<span class="co">#&gt; 6 Samir    2017-04      2018-07</span>

<span class="va">enrollments</span> <span class="op">&lt;-</span> <span class="va">enrollments</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>active <span class="op">=</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv.html">iv</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span>, .keep <span class="op">=</span> <span class="st">"unused"</span><span class="op">)</span>

<span class="va">enrollments</span>
<span class="co">#&gt; # A tibble: 6 × 2</span>
<span class="co">#&gt;   name                 active</span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;iv&lt;ymd&lt;month&gt;&gt;&gt;</span>
<span class="co">#&gt; 1 Amy      [2017-01, 2018-08)</span>
<span class="co">#&gt; 2 Franklin [2017-01, 2017-03)</span>
<span class="co">#&gt; 3 Franklin [2017-06, 2018-03)</span>
<span class="co">#&gt; 4 Franklin [2018-10, 2019-04)</span>
<span class="co">#&gt; 5 Samir    [2017-01, 2017-03)</span>
<span class="co">#&gt; 6 Samir    [2017-04, 2018-07)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To answer this question, we are going to need to create a sequential vector of months that span the entire range of intervals. This starts at the smallest <code>start</code> and goes to the largest <code>end</code>. Because the <code>end</code> is half-open, there won’t be any hits for that month, so we won’t include it.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">enrollments</span><span class="op">$</span><span class="va">active</span><span class="op">)</span>
<span class="va">lower</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv-accessors.html">iv_start</a></span><span class="op">(</span><span class="va">bounds</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="va">upper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv-accessors.html">iv_end</a></span><span class="op">(</span><span class="va">bounds</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1L</span>

<span class="va">months</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">lower</span>, <span class="va">upper</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="va">months</span>
<span class="co">#&gt; # A tibble: 27 × 1</span>
<span class="co">#&gt;    month       </span>
<span class="co">#&gt;    &lt;ymd&lt;month&gt;&gt;</span>
<span class="co">#&gt;  1 2017-01     </span>
<span class="co">#&gt;  2 2017-02     </span>
<span class="co">#&gt;  3 2017-03     </span>
<span class="co">#&gt;  4 2017-04     </span>
<span class="co">#&gt;  5 2017-05     </span>
<span class="co">#&gt;  6 2017-06     </span>
<span class="co">#&gt;  7 2017-07     </span>
<span class="co">#&gt;  8 2017-08     </span>
<span class="co">#&gt;  9 2017-09     </span>
<span class="co">#&gt; 10 2017-10     </span>
<span class="co">#&gt; # … with 17 more rows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To finish up, we need to add a column to <code>months</code> to represent the number of subscriptions that were active in that month. To do this we can use <code><a href="https://davisvaughan.github.io/ivs/reference/iv_count_between.html">iv_count_between()</a></code>, which returns an integer vector corresponding to the number of times the <code>i</code>-th month fell between any of the intervals in the active subscription interval vector.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">months</span> <span class="op">&lt;-</span> <span class="va">months</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv_count_between.html">iv_count_between</a></span><span class="op">(</span><span class="va">month</span>, <span class="va">enrollments</span><span class="op">$</span><span class="va">active</span><span class="op">)</span><span class="op">)</span>

<span class="va">months</span>
<span class="co">#&gt; # A tibble: 27 × 2</span>
<span class="co">#&gt;    month        count</span>
<span class="co">#&gt;    &lt;ymd&lt;month&gt;&gt; &lt;int&gt;</span>
<span class="co">#&gt;  1 2017-01          3</span>
<span class="co">#&gt;  2 2017-02          3</span>
<span class="co">#&gt;  3 2017-03          1</span>
<span class="co">#&gt;  4 2017-04          2</span>
<span class="co">#&gt;  5 2017-05          2</span>
<span class="co">#&gt;  6 2017-06          3</span>
<span class="co">#&gt;  7 2017-07          3</span>
<span class="co">#&gt;  8 2017-08          3</span>
<span class="co">#&gt;  9 2017-09          3</span>
<span class="co">#&gt; 10 2017-10          3</span>
<span class="co">#&gt; # … with 17 more rows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="index_files/figure-html/number-of-active-enrollments-1.png" class="img-fluid" alt="Line chart of monthly enrollments over time with a slight decrease in enrollments over the years" width="672"></p>
</div>
</div>
<p>Also available are <code><a href="https://davisvaughan.github.io/ivs/reference/relation-count.html">iv_count_overlaps()</a></code>, <code><a href="https://davisvaughan.github.io/ivs/reference/relation-count.html">iv_count_precedes()</a></code>, and <code><a href="https://davisvaughan.github.io/ivs/reference/relation-count.html">iv_count_follows()</a></code> for counting relationships between two ivs.</p>
</section><section id="set-operations" class="level2"><h2 class="anchored" data-anchor-id="set-operations">Set operations</h2>
<p>There are a number of set theoretical operations that you can use on ivs. These are:</p>
<ul>
<li><p><code><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_complement()</a></code></p></li>
<li><p><code><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_union()</a></code></p></li>
<li><p><code><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_intersect()</a></code></p></li>
<li><p><code><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_difference()</a></code></p></li>
<li><p><code><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_symmetric_difference()</a></code></p></li>
</ul>
<p><code><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_complement()</a></code> works on a single iv, while all the others work on two ivs at a time. The easiest way to think about these functions is to imagine <code><a href="https://davisvaughan.github.io/ivs/reference/iv-groups.html">iv_groups()</a></code> being called on each of the inputs first (to reduce them down to their minimal form) before applying the operation.</p>
<p><code><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_complement()</a></code> computes the set complement of the intervals in a single iv.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv.html">iv_pairs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">12</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">13</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span>
<span class="va">x</span>
<span class="co">#&gt; &lt;iv&lt;double&gt;[4]&gt;</span>
<span class="co">#&gt; [1] [1, 3)   [2, 5)   [10, 12) [13, 15)</span>

<span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_complement</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="co">#&gt; &lt;iv&lt;double&gt;[2]&gt;</span>
<span class="co">#&gt; [1] [5, 10)  [12, 13)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="omnigraffle/ivs/complement.png" class="img-fluid"></p>
<p>By default, <code><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_complement()</a></code> uses the smallest/largest values of its input as the bounds to compute the complement over, but, as we showed back in the <code><a href="https://davisvaughan.github.io/ivs/reference/iv-groups.html">iv_groups()</a></code> section, you can supply bounds explicitly with <code>lower</code> and <code>upper</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_complement</a></span><span class="op">(</span><span class="va">x</span>, upper <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>
<span class="co">#&gt; &lt;iv&lt;double&gt;[3]&gt;</span>
<span class="co">#&gt; [1] [5, 10)  [12, 13) [15, 20)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="omnigraffle/ivs/complement-upper.png" class="img-fluid"></p>
<p><code><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_union()</a></code> takes the union of two ivs. It answers the question, “Which intervals are in <code>x</code> or <code>y</code>?”</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv.html">iv_pairs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">13</span>, <span class="fl">16</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">14</span>, <span class="fl">18</span><span class="op">)</span><span class="op">)</span>

<span class="va">x</span>
<span class="co">#&gt; &lt;iv&lt;double&gt;[4]&gt;</span>
<span class="co">#&gt; [1] [1, 3)   [2, 5)   [10, 12) [13, 15)</span>
<span class="va">y</span>
<span class="co">#&gt; &lt;iv&lt;double&gt;[3]&gt;</span>
<span class="co">#&gt; [1] [4, 5)   [13, 16) [14, 18)</span>

<span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_union</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
<span class="co">#&gt; &lt;iv&lt;double&gt;[3]&gt;</span>
<span class="co">#&gt; [1] [1, 5)   [10, 12) [13, 18)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="omnigraffle/ivs/union.png" class="img-fluid"></p>
<p><code><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_intersect()</a></code> takes the intersection of two ivs. It answers the question, “Which intervals are in <code>x</code> and <code>y</code>?”</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_intersect</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
<span class="co">#&gt; &lt;iv&lt;double&gt;[2]&gt;</span>
<span class="co">#&gt; [1] [4, 5)   [13, 15)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="omnigraffle/ivs/intersect.png" class="img-fluid"></p>
<p><code><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_difference()</a></code> takes the asymmetrical difference of two ivs. It answers the question, “Which intervals are in <code>x</code> but not <code>y</code>?”</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span class="fu"><a href="https://davisvaughan.github.io/ivs/reference/iv-sets.html">iv_difference</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
<span class="co">#&gt; &lt;iv&lt;double&gt;[2]&gt;</span>
<span class="co">#&gt; [1] [1, 4)   [10, 12)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="omnigraffle/ivs/difference.png" class="img-fluid"></p>
</section><section id="inspiration" class="level2"><h2 class="anchored" data-anchor-id="inspiration">Inspiration</h2>
<p>ivs was inspired by quite a few places!</p>
<ul>
<li><p><a href="https://github.com/Bioconductor/IRanges">IRanges</a> is a Bioconductor package that served as the biggest inspiration for this package. It is mainly focused on integer intervals for use with genomics, and uses S4 in a way that unfortunately means that their interval objects can’t currently be used as columns in a tibble, but is otherwise a really impressive package.</p></li>
<li><p><a href="https://cse.unl.edu/~choueiry/Documents/Allen-CACM1983.pdf">Maintaining Knowledge about Temporal Intervals</a> is a paper by James Allen that a number of these functions are based on. It is also a great primer on integer algebra.</p></li>
<li><p><a href="https://github.com/Rdatatable/data.table">data.table</a> contains a function named <code>foverlaps()</code> for detecting different types of overlaps. It was also inspired by <code><a href="https://rdrr.io/pkg/IRanges/man/findOverlaps-methods.html">IRanges::findOverlaps()</a></code>. They also have support for non-equi joins, which can also accomplish some of this.</p></li>
</ul>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>